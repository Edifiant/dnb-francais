<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objectif Brevet - Cahier de R√©visions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --bristol: #ffffff; --marge: #fb7185; --ligne: #e2e8f0;
            --bleu: #2563eb; --violet: #7c3aed; --vert: #10b981; --orange: #f59e0b;
            --texte: #1e293b; --texte-sec: #334155; --card-border: #e2e8f0;
            --nav-bg: #ffffff; --nav-text: #1e293b;
            --highlight-bg: #f1f5f9;
            --quiz-bg: #ffffff;
            --opt-bg: #f8fafc; --opt-hover: #eff6ff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--texte); margin: 0; padding: 0; }
        
        /* Header & Nav */
        header { background: white; padding: 20px; text-align: center; border-bottom: 3px solid var(--bleu); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.5rem; color: var(--bleu); text-transform: uppercase; letter-spacing: 1px; }
        
        nav { display: flex; overflow-x: auto; background: var(--nav-bg); padding: 10px; gap: 10px; border-bottom: 1px solid var(--ligne); }
        nav::-webkit-scrollbar { height: 5px; }
        nav::-webkit-scrollbar-thumb { background: var(--ligne); border-radius: 10px; }
        
        nav button { 
            white-space: nowrap; padding: 10px 20px; border: 1px solid var(--ligne); 
            background: white; border-radius: 20px; cursor: pointer; font-weight: 600;
            transition: all 0.2s; color: var(--texte-sec);
        }
        nav button.active { background: var(--bleu); color: white; border-color: var(--bleu); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }

        /* Conteneur principal */
        #app { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        
        /* Fiche Bristol (Auteurs & Cours) */
        .fiche-bristol {
            background: var(--bristol); border-radius: 8px; border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 25px;
            position: relative; overflow: hidden;
            background-image: repeating-linear-gradient(white, white 24px, var(--ligne) 24px, var(--ligne) 25px);
            line-height: 25px;
        }
        .fiche-bristol::before {
            content: ""; position: absolute; left: 50px; top: 0; bottom: 0;
            width: 2px; background: var(--marge); opacity: 0.5;
        }
        .fiche-bristol h2 { margin-left: 40px; margin-top: 0; color: var(--bleu); font-size: 1.8rem; line-height: 1.2; }
        .auteur-portrait { float: right; width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-left: 20px; }
        .badge-info { display: inline-block; background: var(--highlight-bg); padding: 2px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; color: var(--violet); margin-left: 40px; }
        .info-highlight { margin-left: 40px; padding: 10px; background: #f8fafc; border-left: 4px solid var(--bleu); margin-top: 15px; line-height: 1.4; }

        /* Quiz Cards */
        .card-quiz { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid var(--ligne); }
        .quiz-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; color: var(--texte); line-height: 1.4; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt-btn { 
            background: var(--opt-bg); border: 2px solid var(--ligne); padding: 15px; 
            border-radius: 12px; cursor: pointer; text-align: left; font-size: 0.95rem;
            transition: all 0.2s; font-weight: 500;
        }
        .opt-btn:hover:not(:disabled) { border-color: var(--bleu); background: var(--opt-hover); transform: translateX(5px); }
        .expli-box { margin-top: 15px; padding: 15px; border-radius: 10px; display: none; background: #f0fdf4; border: 1px solid #bbf7d0; font-size: 0.9rem; line-height: 1.5; }

        /* Timeline Auteurs */
        .timeline-container { margin-left: 40px; margin-top: 20px; height: 10px; background: var(--ligne); border-radius: 5px; position: relative; }
        .timeline-bar { position: absolute; height: 100%; background: var(--violet); border-radius: 5px; }
        .timeline-labels { display: flex; justify-content: space-between; margin-left: 40px; margin-top: 5px; font-size: 0.7rem; color: #94a3b8; font-weight: bold; }

        /* Score & Final */
        #score-board { text-align: center; font-weight: 800; font-size: 1.2rem; color: var(--bleu); margin-bottom: 20px; }
        .final-card { background: var(--bleu); color: white; padding: 40px; border-radius: 20px; text-align: center; margin-top: 30px; }
        .big-score { font-size: 4rem; display: block; margin: 10px 0; }
        
        @media (max-width: 600px) { .btn-grid { grid-template-columns: 1fr; } .fiche-bristol::before { left: 30px; } .fiche-bristol h2, .badge-info, .info-highlight, .timeline-container, .timeline-labels { margin-left: 15px; } .auteur-portrait { width: 80px; height: 80px; } }
    </style>
</head>
<body>

<header>
    <h1>üìö Objectif Brevet</h1>
    <div id="current-tab-title" style="font-size: 0.9rem; color: var(--texte-sec); margin-top: 5px;">Auteurs & ≈íuvres</div>
</header>

<nav>
    <button class="active" onclick="loadSheet('951178030', this)">Auteurs</button>
    <button onclick="loadSheet('681177659', this)">‚úçÔ∏è Testez vos connaissances</button>
    <button onclick="loadSheet('1509372483', this)">Vocabulaire</button>
    <button onclick="loadSheet('71542260', this)">Orthographe</button>
    <button onclick="loadSheet('1548545920', this)">Figures de Style</button>
    <button onclick="loadSheet('1392606774', this)">Conjugaison</button>
    <button onclick="loadSheet('360431327', this)">Grammaire</button>
</nav>

<div id="app">
    <div id="score-board"></div>
    <div id="content-area">Chargement...</div>
    <div id="final-box"></div>
</div>

<script>
    const SHEET_ID = '1C_y_kUqG64A53-NqW5mO87SjG-B6T64-07hR567vMoo';
    const app = document.getElementById('content-area');
    const scoreBoard = document.getElementById('score-board');
    const finalBox = document.getElementById('final-box');
    const currentTabTitle = document.getElementById('current-tab-title');

    let currentScore = 0;
    let maxQuizScore = 0;
    let answeredQuestions = new Set();

    async function loadSheet(gid, btn) {
        // UI Reset
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTabTitle.innerText = btn.innerText;
        app.innerHTML = "Chargement des fiches...";
        finalBox.innerHTML = "";
        currentScore = 0;
        maxQuizScore = 0;
        answeredQuestions.clear();

        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
        
        try {
            const response = await fetch(url);
            const csvText = await response.text();
            const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
            render(results.data);
        } catch (error) {
            app.innerHTML = "Erreur de chargement. V√©rifiez votre connexion.";
        }
    }

    function render(data) {
        let html = "";
        let hasQuiz = false;

        data.forEach((row, i) => {
            // --- 1. LOGIQUE PRIORITAIRE : LE QUIZ ---
            // Si une ligne contient une "Question", on affiche un Quiz, m√™me s'il y a un nom d'auteur.
            if (row.Question || row.Type === "QUIZ") {
                hasQuiz = true;
                maxQuizScore++;
                const bonne = (row.Bonne_R√©ponse || "").trim().toUpperCase();
                
                html += `
                <div class="card-quiz" id="q-card-${i}">
                    <div class="quiz-title">${row.Titre || row.Question}</div>
                    <div class="btn-grid">
                        <button class="opt-btn" id="btn-${i}-A" onclick="check('A','${bonne}',${i})">A. ${row.R√©ponse_A || ""}</button>
                        <button class="opt-btn" id="btn-${i}-B" onclick="check('B','${bonne}',${i})">B. ${row.R√©ponse_B || ""}</button>
                        ${row.R√©ponse_C ? `<button class="opt-btn" id="btn-${i}-C" onclick="check('C','${bonne}',${i})">C. ${row.R√©ponse_C}</button>` : ''}
                        ${row.R√©ponse_D ? `<button class="opt-btn" id="btn-${i}-D" onclick="check('D','${bonne}',${i})">D. ${row.R√©ponse_D}</button>` : ''}
                    </div>
                    <div id="ex-${i}" class="expli-box">
                        <strong>üí° Explication :</strong><br>${row.Explication || "Bonne r√©ponse !"}
                    </div>
                </div>`;
            } 
            // --- 2. LOGIQUE AUTEURS ---
            else if (row.Auteur) {
                const siecle = row.Si√®cle || "";
                let progress = 10;
                if(siecle.includes("XVII")) progress = 35;
                else if(siecle.includes("XVIII")) progress = 55;
                else if(siecle.includes("XIX")) progress = 75;
                else if(siecle.includes("XX")) progress = 95;

                html += `
                <div class="fiche-bristol">
                    ${(row.Image||row.image) ? `<img src="${row.Image||row.image}" class="auteur-portrait">` : ''}
                    <div class="badge-info">${siecle} si√®cle</div><br>
                    <h2>${row.Auteur}</h2>
                    <div class="info-highlight"><strong>≈íuvres cl√©s :</strong> <em>${row.≈íuvre || row.Oeuvre || "N/A"}</em></div>
                    <div class="info-highlight" style="border-left-color: var(--vert);"><strong>Courant :</strong> ${row.Courant || row.Mouvement || "N/A"}</div>
                    
                    <div class="timeline-container">
                        <div class="timeline-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="timeline-labels"><span>16e</span><span>17e</span><span>18e</span><span>19e</span><span>20e</span></div>
                </div>`;
            } 
            // --- 3. LOGIQUE COURS G√âN√âRIQUE ---
            else if (row.Titre || row.Contenu) {
                let v = row.Video ? `<div style="margin-top:15px;"><iframe width="100%" height="200" src="${row.Video.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen style="border-radius:10px;"></iframe></div>` : "";
                html += `
                <div class="fiche-bristol">
                    <h2>${row.Titre || "Fiche"}</h2>
                    <div style="margin-left:40px; line-height:1.6; color:var(--texte-sec); white-space:pre-wrap;">${row.Contenu || ""}</div>
                    ${v}
                </div>`;
            }
        });

        app.innerHTML = html || "<p style='text-align:center;'>S√©lectionnez un onglet ou ajoutez des donn√©es.</p>";
        scoreBoard.innerHTML = hasQuiz ? `Score : 0 / ${maxQuizScore}` : "";
    }

    function check(choice, correct, idx) {
        if (answeredQuestions.has(idx)) return;
        answeredQuestions.add(idx);

        const isCorrect = (choice === correct);
        const btn = document.getElementById(`btn-${idx}-${choice}`);
        const expli = document.getElementById(`ex-${idx}`);

        if (isCorrect) {
            btn.style.background = "#dcfce7";
            btn.style.borderColor = "#22c55e";
            currentScore++;
            scoreBoard.innerHTML = `Score : ${currentScore} / ${maxQuizScore}`;
        } else {
            btn.style.background = "#fee2e2";
            btn.style.borderColor = "#ef4444";
            const correctBtn = document.getElementById(`btn-${idx}-${correct}`);
            if(correctBtn) {
                correctBtn.style.background = "#dcfce7";
                correctBtn.style.borderStyle = "dashed";
            }
        }

        expli.style.display = "block";

        if (answeredQuestions.size === maxQuizScore) {
            setTimeout(showFinalResult, 500);
        }
    }

    function showFinalResult() {
        const percent = Math.round((currentScore / maxQuizScore) * 100);
        let comment = "Continue tes efforts ! üí™";
        if(percent === 100) { 
            comment = "PARFAIT ! üèÜ"; 
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
        else if(percent >= 70) comment = "Excellent travail ! ‚ú®";
        
        finalBox.innerHTML = `
            <div class="final-card">
                <h3>Termin√© !</h3>
                <span class="big-score">${currentScore} / ${maxQuizScore}</span>
                <p>${comment}</p>
                <button onclick="location.reload()" style="background:white; color:var(--bleu); border:none; padding:10px 20px; border-radius:10px; font-weight:bold; cursor:pointer;">Recommencer</button>
            </div>`;
    }

    // Chargement initial
    window.onload = () => {
        const firstBtn = document.querySelector('nav button');
        loadSheet('951178030', firstBtn);
    };
</script>

</body>
</html>
