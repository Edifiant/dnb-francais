<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objectif Brevet - Cahier de RÃ©visions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --bristol: #ffffff; --marge: #fb7185; --ligne: #e2e8f0;
            --bleu: #2563eb; --violet: #7c3aed; --vert: #10b981; --orange: #f59e0b;
            --texte: #1e293b; --texte-sec: #334155; --card-border: #e2e8f0;
            --nav-bg: #ffffff; --nav-text: #1e293b;
            --highlight-bg: #f1f5f9;
            --quiz-bg: #ffffff;
            --opt-bg: #f8fafc; --opt-hover: #eff6ff;
        }

        /* --- MODE SOMBRE --- */
        body.dark-mode {
            --bg: #0f172a; --bristol: #1e293b; --marge: #be123c; --ligne: #334155;
            --bleu: #60a5fa; --violet: #a78bfa; --vert: #34d399; --orange: #fbbf24;
            --texte: #f1f5f9; --texte-sec: #cbd5e1; --card-border: #334155;
            --nav-bg: #1e293b; --nav-text: #f1f5f9;
            --highlight-bg: #334155;
            --quiz-bg: #1e293b;
            --opt-bg: #0f172a; --opt-hover: #1e293b;
        }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--texte); transition: background 0.3s, color 0.3s; padding-top: 80px; }
        .container { max-width: 850px; margin: 0 auto; position: relative; }

        /* HEADER FIXE (Score + Mode) */
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--card-border);
            padding: 10px 20px; z-index: 999;
            display: flex; justify-content: space-between; align-items: center;
        }
        body.dark-mode .top-bar { background: rgba(15, 23, 42, 0.9); }

        .score-display { font-weight: 800; font-size: 1.2rem; color: var(--violet); }
        .theme-toggle {
            background: transparent; border: 2px solid var(--card-border); 
            color: var(--texte); padding: 5px 10px; border-radius: 20px; cursor: pointer;
        }

        /* TITRE PRINCIPAL */
        .main-title {
            text-align: center; font-size: 2.8rem; font-weight: 900; 
            margin: 20px 0 30px 0; color: var(--texte); letter-spacing: -0.05em;
        }

        /* Menu de Navigation */
        .nav-menu { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; justify-content: center; }
        .nav-btn { 
            padding: 10px 20px; border-radius: 50px; 
            border: 2px solid var(--btn-color); background: var(--nav-bg); 
            color: var(--btn-color); cursor: pointer; font-weight: 700; 
            transition: all 0.2s ease;
        }
        .nav-btn:hover, .nav-btn.active { background: var(--btn-color); color: white; transform: translateY(-2px); }

        /* Fiches & Quiz */
        .fiche-bristol {
            background: var(--bristol); border: 1px solid var(--card-border); margin-bottom: 30px;
            padding: 45px 35px 45px 80px; position: relative;
            background-image: linear-gradient(var(--ligne) 1px, transparent 1px);
            background-size: 100% 2.6rem; line-height: 2.6rem; 
            border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }
        .fiche-bristol::before { content: ""; position: absolute; top: 0; left: 65px; bottom: 0; width: 2px; background: var(--marge); opacity: 0.6; }
        .fiche-bristol h2 { margin: 0 0 0.8rem 0; color: var(--bleu); font-size: 1.8rem; border-bottom: 3px solid var(--bleu); display: inline-block; line-height: 1.2; }

        .auteur-portrait { width: 110px; height: 140px; object-fit: cover; float: right; margin-left: 20px; border-radius: 12px; border: 4px solid var(--bg); transform: rotate(2deg); }
        .badge-info { background: var(--violet); color: white; padding: 4px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; display: inline-block; margin-bottom: 12px; line-height: 1; }
        .info-highlight { background: var(--highlight-bg); padding: 10px 15px; border-radius: 8px; border-left: 5px solid var(--violet); line-height: 1.5; margin-top: 15px; color: var(--texte); }
        .vigilance-box { background: #fff1f2; padding: 20px; border-radius: 12px; border-left: 6px solid var(--marge); margin-top: 20px; line-height: 1.6; color: #991b1b; }
        body.dark-mode .vigilance-box { background: #450a0a; color: #fecaca; }

        /* TIMELINE */
        .timeline-container { margin-top: 30px; background: var(--ligne); height: 8px; border-radius: 4px; position: relative; clear: both; }
        .timeline-bar { height: 100%; background: var(--violet); border-radius: 4px; transition: 1s ease-out; }
        .timeline-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--texte-sec); margin-top: 8px; font-weight: 600; }

        /* STYLE QUIZ */
        .card-quiz { 
            background: var(--quiz-bg); padding: 30px; border-radius: 16px; 
            border: 1px solid var(--card-border); border-top: 8px solid var(--violet); 
            margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
        }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt-btn { 
            padding: 16px; border: 2px solid var(--card-border); border-radius: 12px; 
            background: var(--opt-bg); cursor: pointer; font-weight: 600; text-align: left;
            transition: all 0.2s; font-size: 1rem; color: var(--texte);
        }
        .opt-btn:hover:not(:disabled) { background: var(--opt-hover); border-color: var(--bleu); color: var(--bleu); }
        .opt-btn:disabled { cursor: default; opacity: 0.7; }
        .opt-btn.success { background: #dcfce7 !important; border-color: #166534 !important; color: #166534 !important; }
        .opt-btn.error { background: #fee2e2 !important; border-color: #991b1b !important; color: #991b1b !important; }

        .expli-box { margin-top: 20px; padding: 20px; background: #eff6ff; border-left: 6px solid var(--bleu); border-radius: 8px; display: none; line-height: 1.6; animation: fadeIn 0.4s ease; color: #1e293b; }
        body.dark-mode .expli-box { background: #172554; color: #e0f2fe; }

        .final-score-box {
            text-align: center; padding: 40px; background: var(--bg); border: 4px dashed var(--violet);
            border-radius: 20px; margin-top: 40px; display: none;
        }
        .big-score { font-size: 3rem; font-weight: 900; color: var(--violet); display: block; margin: 10px 0; }

        @media (max-width: 600px) { .btn-grid { grid-template-columns: 1fr; } .main-title { font-size: 2rem; } }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="score-display" id="scoreBoard">   Score: 0 / 0</div>
    <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">ðŸŒ™</button>
</div>

<div class="container">
    <h1 class="main-title">   Objectif Brevet</h1>
    
    <div class="nav-menu" id="menu"></div>
    <div id="app">Chargement...</div>
    <div id="finalResult" class="final-score-box"></div>
</div>

<script>
/* ===============================
   APP OBJECT
================================ */
const App = {

  state: {
    score: 0,
    maxScore: 0,
    answered: new Set(),
    currentSection: null
  },

  els: {
    app: document.getElementById('app'),
    menu: document.getElementById('menu'),
    scoreBoard: document.getElementById('scoreBoard'),
    finalBox: document.getElementById('finalResult'),
    themeBtn: document.getElementById('themeBtn')
  },

/* ===============================
   INIT
================================ */
  init(){
    this.restoreTheme();
    this.buildMenu();
    this.loadSection(sections[0]);
  },

/* ===============================
   UTILITIES
================================ */
  escapeHTML(str=""){
    return str
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  },

  getYoutubeEmbed(url){
    const match = url?.match(/(?:v=|be\/)([^&]+)/);
    return match ? `https://www.youtube.com/embed/${match[1]}` : null;
  },

/* ===============================
   THEME
================================ */
  toggleTheme(){
    document.body.classList.toggle('dark-mode');
    const dark = document.body.classList.contains('dark-mode');
    localStorage.setItem("theme", dark ? "dark" : "light");
    this.els.themeBtn.innerText = dark ? "â˜€ï¸" : "ðŸŒ™";
  },

  restoreTheme(){
    if(localStorage.getItem("theme")==="dark"){
      document.body.classList.add("dark-mode");
      this.els.themeBtn.innerText="â˜€ï¸";
    }
  },

/* ===============================
   MENU + DATA LOADING
================================ */
  buildMenu(){
    sections.forEach(section=>{
      const btn=document.createElement('button');
      btn.className='nav-btn';
      btn.innerText=section.name;
      btn.style.setProperty('--btn-color',section.color);
      btn.onclick=()=>this.loadSection(section,btn);
      this.els.menu.appendChild(btn);
    });
  },

  loadSection(section, btn){
    this.resetScore();
    this.state.currentSection=section;

    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    btn?.classList.add('active');

    this.els.app.innerHTML="PrÃ©paration du cours...";

    Papa.parse(spreadsheetUrl+section.gid,{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:(results)=>this.render(results.data)
    });
  },

/* ===============================
   SCORE
================================ */
  resetScore(){
    this.state.score=0;
    this.state.maxScore=0;
    this.state.answered.clear();
    this.els.finalBox.style.display="none";
    this.updateScore();
  },

  updateScore(){
    this.els.scoreBoard.innerHTML=`Score: ${this.state.score} / ${this.state.maxScore}`;
  },

/* ===============================
   RENDER MASTER
================================ */
  render(data){
    const html = data.map((row,i)=>this.renderRow(row,i)).join("");
    this.els.app.innerHTML = html || "Aucune donnÃ©e.";
  },

  renderRow(row,i){
    switch(row.Type){
      case "DICTEE": return this.renderDictee(row);
      case "AUTEUR": return this.renderAuteur(row);
      case "COURS": return this.renderCours(row);
      case "QUIZ": return this.renderQuiz(row,i);
      default: return "";
    }
  },

/* ===============================
   RENDER TYPES
================================ */
  renderDictee(row){
    return `
    <div class="fiche-bristol">
      <div class="badge-info" style="background:var(--orange)">DictÃ©e</div>
      <h2>${this.escapeHTML(row.Titre)}</h2>
      <div>${this.escapeHTML(row.Texte)}</div>
      <div class="vigilance-box">${this.escapeHTML(row.Points_Vigilance)}</div>
    </div>`;
  },

  renderAuteur(row){
    return `
    <div class="fiche-bristol">
      <h2>${this.escapeHTML(row.Auteur)}</h2>
      <div class="info-highlight">
        <strong>Å’uvre :</strong> ${this.escapeHTML(row.Å’uvre)}
      </div>
    </div>`;
  },

  renderCours(row){
    let video="";
    const embed=this.getYoutubeEmbed(row.Video);
    if(embed){
      video=`<iframe width="100%" height="315" src="${embed}" allowfullscreen></iframe>`;
    }

    return `
    <div class="fiche-bristol">
      <h2>${this.escapeHTML(row.Titre)}</h2>
      ${video}
      <div>${this.escapeHTML(row.Contenu)}</div>
    </div>`;
  },

  renderQuiz(row,i){
    this.state.maxScore++;

    const correct=row.Bonne_RÃ©ponse?.trim().toUpperCase();

    return `
    <div class="card-quiz" id="q-${i}">
      <div class="quiz-title">${this.escapeHTML(row.Question)}</div>
      <div class="btn-grid">
        ${this.quizBtn(i,'A',row.RÃ©ponse_A,correct)}
        ${this.quizBtn(i,'B',row.RÃ©ponse_B,correct)}
        ${row.RÃ©ponse_C ? this.quizBtn(i,'C',row.RÃ©ponse_C,correct):""}
        ${row.RÃ©ponse_D ? this.quizBtn(i,'D',row.RÃ©ponse_D,correct):""}
      </div>
    </div>`;
  },

  quizBtn(i,letter,text,correct){
    return `
      <button class="opt-btn"
        onclick="App.answer(${i},'${letter}','${correct}')">
        ${letter}. ${this.escapeHTML(text)}
      </button>`;
  },

/* ===============================
   QUIZ LOGIC
================================ */
  answer(id,click,correct){
    if(this.state.answered.has(id)) return;
    this.state.answered.add(id);

    if(click===correct){
      this.state.score++;
      confetti({particleCount:30,spread:50});
    }

    this.updateScore();

    if(this.state.answered.size===this.state.maxScore){
      this.showFinal();
    }
  },

  showFinal(){
    const percent=Math.round(this.state.score/this.state.maxScore*100);
    this.els.finalBox.innerHTML=`<h3>Score final : ${percent}%</h3>`;
    this.els.finalBox.style.display="block";
  }
};

/* ===============================
   GLOBAL HOOKS
================================ */
function toggleTheme(){ App.toggleTheme(); }

App.init();
</script>

</body>
</html>
